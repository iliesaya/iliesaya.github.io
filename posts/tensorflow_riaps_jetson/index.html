<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Tensorflow not initializing during riaps deployment | ayachips</title>

<meta property='og:title' content='Tensorflow not initializing during riaps deployment - ayachips'>
<meta property='og:description' content='Strange error cannot allocate memory in static TLS block under riaps plateform I am deploying on an nvidia Jetson Xavier a Tensorflow / Keras application (tensorflow-gpu==1.13.1&#43;nv19.5).
If I launch my python code outside riaps, it&rsquo;s working , no error. But when I deploy it with riaps_ctrl and launch it, here is the result :
 &lt;class &#39;ImportError&#39;&gt;: Traceback (most recent call last): File &quot;/usr/local/lib/python3.6/dist-packages/tensorflow/python/pywrap_tensorflow.py&quot;, line 58, in &lt;module&gt; from tensorflow.'>
<meta property='og:url' content='http://iliesaya.github.io/posts/tensorflow_riaps_jetson/'>
<meta property='og:site_name' content='ayachips'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/fae7f1c3f6e95cb175a0a49563fd3142?s=256'><meta property='article:author' content='https://www.facebook.com/ayachi.ilies'><meta property='article:section' content='Posts'><meta property='article:published_time' content='2019-09-08T17:23:18&#43;03:00'/><meta property='article:modified_time' content='2019-09-08T17:23:18&#43;03:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@iliesaya'><meta name='twitter:creator' content='@iliesaya'>


<link href="http://iliesaya.github.io/index.xml" rel="alternate" type="application/rss+xml" title="ayachips" />

<link rel="stylesheet" href="/css/style.css"/><link rel='stylesheet' href='http://iliesaya.github.io/css/custom.css'><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="http://iliesaya.github.io/posts/tensorflow_riaps_jetson/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="http://iliesaya.github.io/">
          <h1 class="title is-4">ayachips</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/iliesaya'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="facebook" href='https://www.facebook.com/ayachi.ilies'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/iliesaya'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:iliesaya@gmail.com'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="linkedin" href='https://linkedin.com/in/mohammed-ili%c3%a8s-ayachi-98941041'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
    </div>
    <h2 class="subtitle is-6">September 8, 2019</h2>
    <h1 class="title">Tensorflow not initializing during riaps deployment</h1>
    
    <div class="content">
      

<h1 id="strange-error-cannot-allocate-memory-in-static-tls-block-under-riaps-plateform">Strange error cannot allocate memory in static TLS block under riaps plateform</h1>

<p>I am deploying on an nvidia Jetson Xavier a Tensorflow / Keras application <em>(tensorflow-gpu==1.13.1+nv19.5)</em>.</p>

<p>If I launch my python code outside riaps, it&rsquo;s working , no error. But when I deploy it with riaps_ctrl and launch it, here is the result :</p>

<pre><code>
&lt;class 'ImportError'&gt;: Traceback (most recent call last):
  File &quot;/usr/local/lib/python3.6/dist-packages/tensorflow/python/pywrap_tensorflow.py&quot;, line 58, in &lt;module&gt;
    from tensorflow.python.pywrap_tensorflow_internal import *
  File &quot;/usr/local/lib/python3.6/dist-packages/tensorflow/python/pywrap_tensorflow_internal.py&quot;, line 28, in &lt;module&gt;
    _pywrap_tensorflow_internal = swig_import_helper()
  File &quot;/usr/local/lib/python3.6/dist-packages/tensorflow/python/pywrap_tensorflow_internal.py&quot;, line 24, in swig_import_helper
    _mod = imp.load_module('_pywrap_tensorflow_internal', fp, pathname, description)
  File &quot;/usr/lib/python3.6/imp.py&quot;, line 243, in load_module
    return load_dynamic(name, filename, file)
  File &quot;/usr/lib/python3.6/imp.py&quot;, line 343, in load_dynamic
    return _load(spec)
ImportError: /usr/lib/aarch64-linux-gnu/libgomp.so.1: cannot allocate memory in static TLS block


Failed to load the native TensorFlow runtime.

See https://www.tensorflow.org/install/errors

for some common reasons and solutions.  Include the entire stack trace
above this error message when asking for help.
Traceback (most recent call last):
  File &quot;/usr/local/lib/python3.6/dist-packages/tensorflow/python/pywrap_tensorflow.py&quot;, line 58, in &lt;module&gt;
    from tensorflow.python.pywrap_tensorflow_internal import *
  File &quot;/usr/local/lib/python3.6/dist-packages/tensorflow/python/pywrap_tensorflow_internal.py&quot;, line 28, in &lt;module&gt;
    _pywrap_tensorflow_internal = swig_import_helper()
  File &quot;/usr/local/lib/python3.6/dist-packages/tensorflow/python/pywrap_tensorflow_internal.py&quot;, line 24, in swig_import_helper
    _mod = imp.load_module('_pywrap_tensorflow_internal', fp, pathname, description)
  File &quot;/usr/lib/python3.6/imp.py&quot;, line 243, in load_module
    return load_dynamic(name, filename, file)
  File &quot;/usr/lib/python3.6/imp.py&quot;, line 343, in load_dynamic
    return _load(spec)
ImportError: /usr/lib/aarch64-linux-gnu/libgomp.so.1: cannot allocate memory in static TLS block

</code></pre>

<p>Impossible to update the jetson tensorflow version, because cudnn installed version is 7.3.1 and I don&rsquo;t want to re-flash the device and lose all my riaps installation. If I use a more recent version of tensorflow I have this error:</p>

<pre><code>Loaded runtime CuDNN library: 7.3.1 but source was compiled with: 7.5.0

</code></pre>

<p>The solution I found is to move the Tensorflow include at the very top of the python code :</p>

<pre><code>import tensorflow as tf
from tensorflow import keras
from tensorflow.keras.layers import GlobalAveragePooling2D, ZeroPadding2D, MaxPooling2D, Flatten, Dense, Input, Dropout, Conv2D, BatchNormalization, MaxPool2D, Activation
from tensorflow.keras.models import Model, Sequential
from tensorflow.keras.optimizers import Adam
from tensorflow.keras.regularizers import l2
from tensorflow.keras.layers import MaxPooling1D, Conv1D, GlobalAveragePooling1D, Reshape


from riaps.run.comp import Component
import logging
from random import random
import time as t

from time import mktime
from datetime import datetime
import numpy as np

from sklearn import preprocessing
from sklearn.preprocessing import normalize

</code></pre>

<p>If the import tensorflow are after the sklearn import, it&rsquo;s not working.
This page gave me the hint : <a href="https://www.mail-archive.com/python-devel@lists.fedoraproject.org/msg01516.html" target="_blank">https://www.mail-archive.com/python-devel@lists.fedoraproject.org/msg01516.html</a></p>

<p>I think this bug is specific to the version of tensorflow I have on the jetson because the raspberry pi doesn&rsquo;t have this issue.</p>

      
      <div class="related">
</div>
      
    </div>
    
  </div>
</section>

    <script src="/js/copycode.js"></script>



<section class="section">
  <div class="container has-text-centered">
    <p></p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>

<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="\/\/matomo.example.com\/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript>
  <img src="//matomo.example.com/piwik.php?idsite=1&amp;rec=1" style="border:0" alt="" />
</noscript>


</body>
</html>

